groups:
  - name: duckmesh-slo-recording
    interval: 30s
    rules:
      - record: duckmesh:slo_ingest_ack_latency_ms_p95
        expr: histogram_quantile(0.95, sum(rate(duckmesh_ingest_ack_latency_ms_bucket[5m])) by (le))

      - record: duckmesh:slo_write_to_visible_latency_ms_p95
        expr: histogram_quantile(0.95, sum(rate(duckmesh_write_to_visible_latency_ms_bucket[5m])) by (le))

      - record: duckmesh:slo_consistency_timeouts_15m
        expr: increase(duckmesh_consistency_timeout_total[15m])

      - record: duckmesh:slo_ingest_lag_events
        expr: duckmesh_ingest_lag_events

      - record: duckmesh:slo_visibility_lag_ms
        expr: duckmesh_visibility_lag_ms

      - record: duckmesh:slo_integrity_failures_30m
        expr: increase(duckmesh_integrity_runs_total{status="failed"}[30m])

      - record: duckmesh:slo_integrity_missing_files_30m
        expr: increase(duckmesh_integrity_missing_files_total[30m])

      - record: duckmesh:slo_integrity_failures_24h
        expr: increase(duckmesh_integrity_runs_total{status="failed"}[24h])

      - record: duckmesh:slo_integrity_missing_files_24h
        expr: increase(duckmesh_integrity_missing_files_total[24h])

      - record: duckmesh:slo_http_error_rate_5m
        expr: |
          sum(rate(duckmesh_http_requests_total{status=~"5.."}[5m]))
          /
          clamp_min(sum(rate(duckmesh_http_requests_total[5m])), 1)
